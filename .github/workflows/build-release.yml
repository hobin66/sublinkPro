name: Manual Build & Release (AMD64 Only)

# 1. è§¦å‘æ–¹å¼ï¼šåªå…è®¸æ‰‹åŠ¨ï¼Œä¸”å¿…é¡»è¾“å…¥ç‰ˆæœ¬å·
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'è¯·è¾“å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.1)'
        required: true
        default: '0.0.1'

permissions:
  contents: write
  packages: write

jobs:
  # === ç¬¬ä¸€æ­¥ï¼šæ„å»ºå‰ç«¯ ===
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable Corepack
        run: corepack enable

      - name: Install and Build Frontend
        run: |
          cd webs
          yarn install --immutable
          yarn run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: webs/dist/
          retention-days: 1

  # === ç¬¬äºŒæ­¥ï¼šæ„å»º Go åç«¯ (åªæ„å»º Linux AMD64) ===
  build-go-binary:
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.5'

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: static/

      # å…³é”®æ­¥éª¤ï¼šæŠŠæ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬å·å†™å…¥ VERSION æ–‡ä»¶
      - name: Write version to VERSION file
        run: |
          echo "${{ inputs.version }}" > VERSION
          echo "Current Version is: ${{ inputs.version }}"

      - name: Build Linux AMD64 Binary
        run: |
          mkdir -p build
          echo "Building for Linux AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -tags=prod -ldflags="-s -w" -o build/sublinkPro-linux-amd64 .

      # UPX å‹ç¼© (å¯é€‰ï¼Œå¦‚æœä½ ä¸éœ€è¦å¯ä»¥åˆ æ‰è¿™ä¸€æ­¥)
      - name: Compress binary with UPX
        run: |
          sudo apt-get update && sudo apt-get install -y upx
          upx --best --lzma build/sublinkPro-linux-amd64 || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-binaries
          path: build/
          retention-days: 1

  # === ç¬¬ä¸‰æ­¥ï¼šå‘å¸ƒ GitHub Release ===
  create-release:
    needs: build-go-binary
    runs-on: ubuntu-latest
    steps:
      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          name: go-binaries
          path: build/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨è¾“å…¥çš„ç‰ˆæœ¬å·ä½œä¸º Tag å’Œ æ ‡é¢˜
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }} Manual Release
          body: |
            ## ğŸš€ æ‰‹åŠ¨æ„å»ºå‘å¸ƒ
            
            - **ç‰ˆæœ¬**: ${{ inputs.version }}
            - **æ¶æ„**: Linux AMD64
            - **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          files: |
            build/sublinkPro-linux-amd64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # === ç¬¬å››æ­¥ï¼šæ„å»º Docker é•œåƒ ===
  build-docker:
    needs: [build-frontend, build-go-binary]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # è¿™é‡Œçš„ artifacts ä¸‹è½½æ˜¯ä¸ºäº†è®© Dockerfile.ci èƒ½æ‰¾åˆ°æ–‡ä»¶
      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: static/

      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          name: go-binaries
          path: build/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          VERSION="${{ inputs.version }}"
          echo "Building Docker image for version: $VERSION"
          
          # ç›´æ¥ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬å·æ‰“ tagï¼ŒåŒæ—¶ä¹Ÿæ‰“ latest
          docker buildx build --no-cache --pull --platform linux/amd64 \
            -f Dockerfile.ci \
            -t zerodeng/sublink-pro:$VERSION \
            -t zerodeng/sublink-pro:latest \
            --push .