name: Manual Build & Release (AMD64 -> GitHub Packages)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'è¯·è¾“å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.0.1)'
        required: true
        default: '0.0.1'

# æƒé™é…ç½®éå¸¸é‡è¦ï¼Œpackages: write å…è®¸æ¨é€åˆ° GitHub Packages
permissions:
  contents: write
  packages: write

jobs:
  # === ç¬¬ä¸€æ­¥ï¼šæ„å»ºå‰ç«¯ ===
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable Corepack
        run: corepack enable

      - name: Install and Build Frontend
        run: |
          cd webs
          yarn install --immutable
          yarn run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: webs/dist/
          retention-days: 1

  # === ç¬¬äºŒæ­¥ï¼šæ„å»º Go åç«¯ (AMD64) ===
  build-go-binary:
    needs: build-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.5'

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: static/

      - name: Write version to VERSION file
        run: |
          echo "${{ inputs.version }}" > VERSION
          echo "Current Version is: ${{ inputs.version }}"

      - name: Build Linux AMD64 Binary
        run: |
          mkdir -p build
          echo "Building for Linux AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -tags=prod -ldflags="-s -w" -o build/sublinkPro-linux-amd64 .

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-binaries
          path: build/
          retention-days: 1

  # === ç¬¬ä¸‰æ­¥ï¼šå‘å¸ƒ GitHub Release ===
  create-release:
    needs: build-go-binary
    runs-on: ubuntu-latest
    steps:
      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          name: go-binaries
          path: build/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }} Manual Release
          body: |
            ## ğŸš€ æ‰‹åŠ¨æ„å»ºå‘å¸ƒ (GitHub Packages)
            
            - **ç‰ˆæœ¬**: ${{ inputs.version }}
            - **æ¶æ„**: Linux AMD64
            - **é•œåƒæº**: `ghcr.io/${{ github.repository_owner }}/sublink-pro`
          files: |
            build/sublinkPro-linux-amd64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # === ç¬¬å››æ­¥ï¼šæ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° GitHub Packages ===
  build-docker:
    needs: [build-frontend, build-go-binary]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: static/

      - name: Download binary artifacts
        uses: actions/download-artifact@v4
        with:
          name: go-binaries
          path: build/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ã€å…³é”®ä¿®æ”¹ 1ã€‘ç™»å½• GitHub Container Registry (ghcr.io)
      # ä½¿ç”¨ github.actor (è§¦å‘è€…) å’Œ secrets.GITHUB_TOKEN (è‡ªåŠ¨ç”Ÿæˆçš„ä»¤ç‰Œ)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ã€å…³é”®ä¿®æ”¹ 2ã€‘æ„å»ºå¹¶æ¨é€
      - name: Build and Push Docker Image
        run: |
          VERSION="${{ inputs.version }}"
          
          # å®šä¹‰é•œåƒåç§°: ghcr.io/ç”¨æˆ·å/sublink-pro
          # ä½¿ç”¨ ${{ github.repository_owner }} è‡ªåŠ¨å¡«å…¥ä½ çš„ GitHub ç”¨æˆ·å
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/sublink-pro"
          
          # âš ï¸ å¿…é¡»è½¬ä¸ºå…¨å°å†™ (Docker å¼ºåˆ¶è¦æ±‚)
          IMAGE_NAME=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          
          echo "Target Image: $IMAGE_NAME:$VERSION"
          
          docker buildx build --no-cache --pull --platform linux/amd64 \
            -f Dockerfile.ci \
            -t $IMAGE_NAME:$VERSION \
            -t $IMAGE_NAME:latest \
            --push .